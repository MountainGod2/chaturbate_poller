name: Manual Operations

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - 'force-release'
          - 'rebuild-containers'
          - 'security-scan'
          - 'dependency-update'
          - 'cleanup-packages'
      target:
        description: 'Target (version, tag, etc.)'
        required: false
        type: string

env:
  DEFAULT_PYTHON: "3.13"
  UV_CACHE_DIR: /tmp/uv-cache
  FORCE_COLOR: "1"

permissions:
  contents: write
  packages: write
  security-events: write

jobs:
  dispatch:
    runs-on: ubuntu-24.04
    steps:
      - name: Trigger Workflow
        if: ${{ inputs.operation != 'cleanup-packages' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const workflows = {
              'force-release': 'cd.yml',
              'rebuild-containers': 'container.yml',
              'security-scan': 'security.yml',
              'dependency-update': 'dependencies.yml'
            };

            const workflow = workflows['${{ inputs.operation }}'];
            if (!workflow) {
              core.setFailed(`Unknown operation: ${{ inputs.operation }}`);
              return;
            }

            const workflowInputs = {};
            if ('${{ inputs.operation }}' === 'force-release' && '${{ inputs.target }}') {
              workflowInputs.force_release = '${{ inputs.target }}';
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref: 'main',
              inputs: workflowInputs
            });

      - name: Cleanup Packages
        if: ${{ inputs.operation == 'cleanup-packages' }}
        uses: actions/delete-package-versions@e5bc658cc4c965c472efe991f8beea3981499c55 # v5
        with:
          package-name: chaturbate_poller
          package-type: container
          min-versions-to-keep: 10
          delete-only-untagged-versions: true

      - name: Summary
        run: |
          echo "## Manual Operation: ${{ inputs.operation }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ inputs.target || 'default' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Completed" >> $GITHUB_STEP_SUMMARY
