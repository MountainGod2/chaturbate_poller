# Shared Build, Test & Quality Workflow
# Provides reusable build, test, lint, security, and deployment capabilities
name: Shared Build & Test

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version'
        type: string
        default: '3.13'
      install-groups:
        description: 'Dependency groups to install (comma-separated or "all")'
        type: string
        default: 'dev'
      runner:
        description: 'Runner to use for the job'
        type: string
        default: 'ubuntu-24.04'
      fetch-depth:
        description: 'Number of commits to fetch. 0 indicates all history'
        type: number
        default: 1
      checkout-token:
        description: 'Token to use for checkout'
        type: string
        default: ''
      persist-credentials:
        description: 'Whether to persist credentials after checkout'
        type: boolean
        default: false
      skip-install:
        description: 'Skip dependency installation'
        type: boolean
        default: false
      run-tests:
        description: 'Whether to run tests'
        type: boolean
        default: false
      run-lint:
        description: 'Whether to run linting'
        type: boolean
        default: false
      run-type-check:
        description: 'Whether to run type checking'
        type: boolean
        default: false
      run-security:
        description: 'Whether to run security scans'
        type: boolean
        default: false
      coverage-upload:
        description: 'Whether to upload coverage results'
        type: boolean
        default: false
      test-args:
        description: 'Additional arguments for pytest'
        type: string
        default: '--junit-xml=test-results.xml -n auto --maxfail=5 --cov=src/chaturbate_poller --cov-report=xml'
      extra-commands:
        description: 'Additional commands to run after setup'
        type: string
        default: ''
      artifact-suffix:
        description: 'Suffix to append to artifact names for uniqueness'
        type: string
        default: ''
    secrets:
      CODECOV_TOKEN:
        description: 'Token for codecov upload'
        required: false
    outputs:
      python-version:
        description: 'Python version used'
        value: ${{ jobs.main.outputs.python-version }}
      runner:
        description: 'Runner used'
        value: ${{ jobs.main.outputs.runner }}
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.main.outputs.artifact-name }}

env:
  UV_CACHE_DIR: /tmp/uv-cache
  FORCE_COLOR: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  main:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 30
    outputs:
      python-version: ${{ steps.output.outputs.python-version }}
      runner: ${{ steps.output.outputs.runner }}
      artifact-name: ${{ steps.output.outputs.artifact-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: ${{ inputs.fetch-depth }}
          token: ${{ inputs.checkout-token || github.token }}
          persist-credentials: ${{ inputs.persist-credentials }}

      - name: Setup UV & Python
        uses: astral-sh/setup-uv@445689ea25e0de0a23313031f5fe577c74ae45a1 # v4.2.0
        with:
          enable-cache: true
          python-version: ${{ inputs.python-version }}
          cache-dependency-glob: uv.lock

      - name: Initialize CodeQL
        if: ${{ inputs.run-security }}
        uses: github/codeql-action/init@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
        with:
          languages: python

      - name: Install Dependencies
        if: ${{ !inputs.skip-install }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ inputs.install-groups }}" == "all" ]]; then
            echo "Installing all dependency groups..."
            uv sync --all-groups
          elif [[ "${{ inputs.install-groups }}" == "none" ]]; then
            echo "Installing base dependencies only..."
            uv sync --no-group dev --no-group docs
          elif [[ "${{ inputs.install-groups }}" == *","* ]]; then
            echo "Installing specific dependency groups: ${{ inputs.install-groups }}"
            # Convert comma-separated groups to --group flags
            groups=$(echo "${{ inputs.install-groups }}" | tr ',' '\n' | sed 's/^[[:space:]]*/--group /' | tr '\n' ' ')
            echo "Computed groups: $groups"
            uv sync $groups
          else
            echo "Installing single dependency group: ${{ inputs.install-groups }}"
            uv sync --group=${{ inputs.install-groups }}
          fi

      - name: Validate Environment
        if: ${{ !inputs.skip-install }}
        shell: bash
        run: |
          echo "Python version: $(python --version)"
          echo "UV version: $(uv --version)"
          echo "Installed packages:"
          uv pip list || echo "Could not list packages"

      - name: Run Code Quality Checks
        if: ${{ inputs.run-lint }}
        shell: bash
        run: |
          echo "::group::Ruff Format Check"
          uv run ruff format --check --diff src/ tests/
          echo "::endgroup::"

          echo "::group::Ruff Lint Check"
          uv run ruff check src/ tests/
          echo "::endgroup::"

      - name: Run Type Checking
        if: ${{ inputs.run-type-check }}
        shell: bash
        run: |
          echo "::group::MyPy Type Check"
          uv run mypy src/
          echo "::endgroup::"

          echo "::group::BasedPyright Type Check"
          uv run basedpyright src/
          echo "::endgroup::"

      - name: Run Tests
        if: ${{ inputs.run-tests }}
        shell: bash
        run: |
          echo "::group::Running Tests"
          uv run pytest ${{ inputs.test-args }}
          echo "::endgroup::"

      - name: Upload Coverage to Codecov
        if: ${{ inputs.coverage-upload && inputs.run-tests }}
        uses: codecov/codecov-action@015f24e6818733317a2da2edd6290ab26238649a # v5.0.7
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: false
          verbose: true

      - name: Run Security Scans
        if: ${{ inputs.run-security }}
        run: |
          echo "::group::Bandit Security Scan"
          uv run bandit -r src/ -f sarif -o bandit.sarif || echo "Bandit scan completed with warnings"
          echo "::endgroup::"

          echo "::group::Pip-audit Security Scan"
          uv run --with pip-audit pip-audit --format=sarif --output=audit.sarif --progress-spinner=off || echo "Pip-audit completed with warnings"
          echo "::endgroup::"

      - name: Perform CodeQL Analysis
        if: ${{ inputs.run-security }}
        uses: github/codeql-action/analyze@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1

      - name: Run Trivy vulnerability scanner
        if: ${{ inputs.run-security }}
        uses: aquasecurity/trivy-action@0.31.0
        with:
          scan-type: 'fs'
          skip-dirs: '.git,.github,.venv,docs/_build,htmlcov'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Security Results
        if: ${{ inputs.run-security && always() }}
        uses: github/codeql-action/upload-sarif@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
        with:
          sarif_file: |
            bandit.sarif
            audit.sarif
            trivy-results.sarif
          category: security-scan

      - name: Run Extra Commands
        if: ${{ inputs.extra-commands != '' }}
        run: ${{ inputs.extra-commands }}

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: workflow-artifacts-${{ github.run_id }}${{ inputs.artifact-suffix != '' && format('-{0}', inputs.artifact-suffix) || '' }}
          path: |
            *.sarif
            *.json
            *.xml
            test-results.xml
            coverage.xml
          if-no-files-found: ignore
          retention-days: 30

      - name: Set Outputs
        id: output
        run: |
          echo "python-version=${{ inputs.python-version }}" >> $GITHUB_OUTPUT
          echo "runner=${{ inputs.runner }}" >> $GITHUB_OUTPUT
          echo "artifact-name=workflow-artifacts-${{ github.run_id }}${{ inputs.artifact-suffix != '' && format('-{0}', inputs.artifact-suffix) || '' }}" >> $GITHUB_OUTPUT
