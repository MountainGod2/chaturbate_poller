name: Dependencies

on:
  pull_request:
    paths: ['uv.lock', 'pyproject.toml']
  schedule:
    - cron: "0 4 * * 1" # Weekly dependency check
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

  audit:
    uses: ./.github/workflows/_shared-build-test.yml
    with:
      python-version: '3.13'
      install-groups: 'dev'
      extra-commands: |
        uv run --with pip-audit pip-audit --format=sarif --output=audit.sarif || true

  upload-audit:
    needs: audit
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3
        with:
          sarif_file: audit.sarif
          category: pip-audit
