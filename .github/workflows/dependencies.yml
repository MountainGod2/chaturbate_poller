name: Dependencies

on:
  pull_request:
    paths: ['uv.lock', 'pyproject.toml']
  schedule:
    - cron: "0 4 * * 1" # Weekly dependency check
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

  audit:
    uses: ./.github/workflows/_shared-build-test.yml
    with:
      python-version: '3.13'
      install-groups: 'dev'
      artifact-suffix: audit
      extra-commands: |
        echo "Running pip-audit security scan..."
        uv run --with pip-audit pip-audit --format=sarif --output=audit.sarif --progress-spinner=off || {
          echo "pip-audit failed, creating empty SARIF file"
          echo '{"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "pip-audit"}}, "results": []}]}' > audit.sarif
        }
        if [ -f "audit.sarif" ]; then
          echo "audit.sarif created successfully"
          echo "File size: $(wc -c < audit.sarif) bytes"
        else
          echo "WARNING: audit.sarif was not created"
        fi

  upload-audit:
    needs: audit
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Download Audit Results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: ${{ needs.audit.outputs.artifact-name }}
          path: .
        continue-on-error: true

      - name: Upload SARIF file
        if: hashFiles('audit.sarif') != ''
        uses: github/codeql-action/upload-sarif@ce28f5bb42b7a9f2c824e633a3f6ee835bab6858 # v3
        with:
          sarif_file: audit.sarif
          category: pip-audit
