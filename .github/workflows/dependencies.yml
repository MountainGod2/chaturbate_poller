# Dependency Management & Security Auditing
name: Dependencies

on:
  pull_request:
    paths: ['uv.lock', 'pyproject.toml']
  schedule:
    - cron: "0 4 * * 1" # Weekly dependency check at 4 AM UTC on Mondays
  workflow_dispatch:

env:
  DEFAULT_PYTHON: "3.13"
  UV_CACHE_DIR: /tmp/uv-cache
  FORCE_COLOR: "1"

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: dependencies-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Review dependency changes in pull requests
  review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@da24556b548a50705dd671f47852072ea4c105d9 # v4.3.7
        with:
          fail-on-severity: high
          comment-summary-in-pr: true
          vulnerability-check: true
          license-check: true

  # Security audit of dependencies
  audit:
    uses: ./.github/workflows/_shared-build-test.yml
    with:
      python-version: '3.13'
      install-groups: 'dev'
      artifact-suffix: 'audit'
      extra-commands: |
        echo "::group::Dependency Security Audit"
        uv run --with pip-audit pip-audit --format=sarif --output=audit.sarif --progress-spinner=off || {
          echo "pip-audit failed, creating minimal SARIF file"
          echo '{"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "pip-audit"}}, "results": []}]}' > audit.sarif
        }

        echo "::group::Generate SBOM"
        uv run --with pip-audit pip-audit --format=cyclonedx-json --output=sbom.json --progress-spinner=off || {
          echo "SBOM generation failed"
          echo '{"components": []}' > sbom.json
        }
        echo "::endgroup::"

        if [ -f "audit.sarif" ]; then
          echo "âœ“ Security audit completed successfully"
          echo "File size: $(wc -c < audit.sarif) bytes"
        else
          echo "âš ï¸ WARNING: audit.sarif was not created"
        fi

  # Upload security results to GitHub Security tab
  upload-audit:
    needs: audit
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Download Audit Results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: ${{ needs.audit.outputs.artifact-name }}
          path: .
        continue-on-error: true

      - name: Upload Security Audit Results
        if: hashFiles('audit.sarif') != ''
        uses: github/codeql-action/upload-sarif@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
        with:
          sarif_file: audit.sarif
          category: dependency-audit
          wait-for-processing: true

      - name: Upload SBOM Artifact
        if: hashFiles('sbom.json') != ''
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.json
          retention-days: 90

  # Summary job for reporting
  summary:
    if: always()
    needs: [audit, upload-audit]
    runs-on: ubuntu-24.04
    steps:
      - name: Dependency Audit Summary
        run: |
          echo "## Dependency Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Audit Status:** ${{ needs.audit.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Upload Status:** ${{ needs.upload-audit.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.audit.result }}" == "success" ]]; then
            echo "âœ… **Result:** No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.audit.result }}" == "failure" ]]; then
            echo "âŒ **Result:** Security issues detected - check Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Result:** Audit was skipped or cancelled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Check the Security tab for detailed vulnerability reports." >> $GITHUB_STEP_SUMMARY
